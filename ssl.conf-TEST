LoadModule ssl_module modules/mod_ssl.so
LoadModule proxy_http_module modules/mod_proxy_http.so

PerlRequire /etc/httpd/scripts/startup.pl
PerlRequire /etc/httpd/scripts/constants.pl

Listen 443
#For SSOe, later
#Listen 444
SSLProxyEngine On
ProxyRequests Off
ProxyPreserveHost On
ProxyTimeout 600
SSLPassPhraseDialog  builtin
SSLSessionCache         shmcb:/var/cache/mod_ssl/scache(512000)
SSLSessionCacheTimeout  300
SSLMutex default
SSLRandomSeed startup file:/dev/urandom  256
SSLRandomSeed connect builtin
#SSLRandomSeed startup file:/dev/random  512
#SSLRandomSeed connect file:/dev/random  512
#SSLRandomSeed connect file:/dev/urandom 512
SSLCryptoDevice builtin
#SSLCryptoDevice ubsec

# The virtualhost below 443 is for SSOi
<VirtualHost _default_:443>
    ErrorLog logs/ssl_error_log
    TransferLog logs/ssl_access_log
    LogLevel info
    SSLEngine on
    #SSLProtocol all -SSLv2
    #SSLCipherSuite DEFAULT:!EXP:!SSLv2:!DES:!IDEA:!SEED:+3DES
    # The 3 lines below fixes the BEAST exploit
    ###########################################
    SSLProtocol all -TLSv1.1 -TLSv1 -SSLv2 -SSLv3
    #SSLCipherSuite ALL:+HIGH:!ADH:!EXP:!SSLv2:!SSLv3:!NULL:!aNULL
    SSLCipherSuite DHE-DSS-AES128-GCM-SHA256:DHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-SHA384:DHE-DSS-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384:ADH-AES256-GCM-SHA384:ECDH-RSA-AES256-GCM-SHA384:ECDH-ECDSA-AES256-GCM-SHA384:ECDH-ECDSA-AES256-SHA384:AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ADH-AES128-GCM-SHA256:ECDH-ECDSA-AES128-GCM-SHA256:ECDH-ECDSA-AES128-SHA256:ADH-AES128-GCM-SHA256:ECDH-ECDSA-AES128-GCM-SHA256:ECDH-ECDSA-AES128-SHA256:AES128-GCM-SHA256
    SSLHonorCipherOrder on
    ###########################################
    
    SSLCertificateFile /app/certs/cert0602017/server.crt
    SSLCertificateKeyFile /app/certs/cert0602017/server.key
    
    SSLVerifyClient none
    <Files ~ "\.(cgi|shtml|phtml|php3?)$">
        SSLOptions +StdEnvVars
    </Files>
    <Directory "/var/www/cgi-bin">
        SSLOptions +StdEnvVars
    </Directory>
    SetEnvIf User-Agent ".*MSIE.*" \
             nokeepalive ssl-unclean-shutdown \
             downgrade-1.0 force-response-1.0
    CustomLog logs/ssl_request_log \
              "%t %h %{SSL_PROTOCOL}x %{SSL_CIPHER}x \"%r\" %b"
</VirtualHost>

#Rewrite Rules
################# Server dbs 82 #################
<Location /rails_prisme>
    RequestHeader set apache_time "%D,%t"
    ProxyPass https://vaauscttdbs82.aac.va.gov:8080/rails_prisme
    ProxyPassReverse https://vaauscttdbs82.aac.va.gov:8080/rails_prisme
    SetEnv proxy-sendchunks 1
</Location>

<Location /git>
    PerlFixupHandler Prisme::ValidateHeader
    ProxyPass https://vaauscttdbs82.aac.va.gov:8080/git
    ProxyPassReverse https://vaauscttdbs82.aac.va.gov:8080/git
</Location>


################# Server web 83 #################
<Location /nexus>
    PerlFixupHandler Prisme::ValidateHeader
    ProxyPass https://vaauscttweb83.aac.va.gov:8443/nexus
    ProxyPassReverse https://vaauscttweb83.aac.va.gov:8443/nexus
</Location>

<Location /jenkins>
    PerlFixupHandler Prisme::ValidateHeader
    ProxyPass https://vaauscttweb83.aac.va.gov:8080/jenkins
    ProxyPassReverse https://vaauscttweb83.aac.va.gov:8080/jenkins
</Location>

<Location /ntrt>
    PerlFixupHandler Prisme::ValidateHeader
    ProxyPass https://vaauscttweb83.aac.va.gov:8088/ntrt
    ProxyPassReverse https://vaauscttweb83.aac.va.gov:8088/ntrt
</Location>


################# Server web 84 #################
<Location /1/isaac-rest>
    ProxyPass https://vaauscttweb84.aac.va.gov:8080/isaac-rest_1
    ProxyPassReverse https://vaauscttweb84.aac.va.gov:8080/isaac-rest
</Location>

<Location /2/isaac-rest>
    ProxyPass https://vaauscttweb84.aac.va.gov:8080/isaac-rest_2
    ProxyPassReverse https://vaauscttweb84.aac.va.gov:8080/isaac-rest
</Location>

<Location /1/rails_komet_a>
    ProxyPass https://vaauscttweb84.aac.va.gov:8080/rails_komet_a
    ProxyPassReverse https://vaauscttweb84.aac.va.gov:8080/rails_komet_a
</Location>

<Location /2/rails_komet_b>
    ProxyPass https://vaauscttweb84.aac.va.gov:8080/rails_komet_b
    ProxyPassReverse https://vaauscttweb84.aac.va.gov:8080/rails_komet_b
</Location>


################# Server web 85 #################
<Location /3/isaac-rest>
    ProxyPass https://vaauscttweb85.aac.va.gov:8080/isaac-rest_1
    ProxyPassReverse https://vaauscttweb85.aac.va.gov:8080/isaac-rest
</Location>

<Location /4/isaac-rest>
    ProxyPass https://vaauscttweb85.aac.va.gov:8080/isaac-rest_2
    ProxyPassReverse https://vaauscttweb85.aac.va.gov:8080/isaac-rest
</Location>

<Location /3/rails_komet_a>
    ProxyPass https://vaauscttweb85.aac.va.gov:8080/rails_komet_a
    ProxyPassReverse https://vaauscttweb85.aac.va.gov:8080/rails_komet_a
</Location>

<Location /4/rails_komet_b>
    ProxyPass https://vaauscttweb85.aac.va.gov:8080/rails_komet_b
    ProxyPassReverse https://vaauscttweb85.aac.va.gov:8080/rails_komet_b
</Location>